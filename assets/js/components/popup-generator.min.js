/**
 * AI Content Generator Popup - Vanilla JavaScript Version
 * Compiled from React JSX for WordPress compatibility
 */

(function() {
    'use strict';

    // React element creator helper
    const createElement = React.createElement;
    const useState = React.useState;
    const useEffect = React.useEffect;

    function ContentGeneratorPopup(props) {
        const { postId, postTitle, postContent, postType, onClose } = props;
        
        // State hooks
        const [selectedOptions, setSelectedOptions] = useState([]);
        const [isGenerating, setIsGenerating] = useState(false);
        const [generatedContent, setGeneratedContent] = useState({});
        const [error, setError] = useState(null);
        const [currentStep, setCurrentStep] = useState('select');
        const [instructions, setInstructions] = useState({});
        const [lengthSettings, setLengthSettings] = useState({
            title: 60,
            content: 500,
            excerpt: 150,
            keywords: 10,
            short_description: 100,
            description: 300
        });
        const [selectedModel] = useState('gpt-3.5-turbo');
        const [selectedProvider] = useState('OpenAI');
        const [calculatedTokens, setCalculatedTokens] = useState(null);
        const [isCalculating, setIsCalculating] = useState(false);

        // Available options based on post type
        const getAvailableOptions = function() {
            if (postType === 'product') {
                return [
                    { key: 'title', label: 'Product Title', icon: 'üìù', description: 'Generate SEO-optimized product title' },
                    { key: 'description', label: 'Full Description', icon: 'üìÑ', description: 'Create detailed product description' },
                    { key: 'short_description', label: 'Short Description', icon: 'üìã', description: 'Generate concise product summary' },
                    { key: 'keywords', label: 'SEO Keywords', icon: 'üè∑Ô∏è', description: 'Generate relevant keywords' }
                ];
            } else {
                return [
                    { key: 'title', label: 'Post Title', icon: 'üìù', description: 'Generate engaging post title' },
                    { key: 'content', label: 'Post Content', icon: 'üìÑ', description: 'Create full blog post content' },
                    { key: 'excerpt', label: 'Post Excerpt', icon: 'üìã', description: 'Generate post summary' },
                    { key: 'keywords', label: 'SEO Keywords', icon: 'üè∑Ô∏è', description: 'Generate relevant keywords' }
                ];
            }
        };

        const availableOptions = getAvailableOptions();

        // Toggle option selection
        const toggleOption = function(optionKey) {
            setSelectedOptions(function(prev) {
                if (prev.includes(optionKey)) {
                    return prev.filter(function(key) { return key !== optionKey; });
                }
                return prev.concat([optionKey]);
            });
        };

        // Calculate tokens
        const calculateTokens = async function() {
            if (selectedOptions.length === 0) {
                setError('Please select at least one option');
                return;
            }

            setIsCalculating(true);
            setError(null);

            try {
                const formData = new URLSearchParams({
                    post_id: postId,
                    selected_options: JSON.stringify(selectedOptions),
                    length_settings: JSON.stringify(lengthSettings),
                    instructions: JSON.stringify(instructions),
                    model: selectedModel,
                    provider: selectedProvider,
                    nonce: window.aiSettings.nonce,
                    action: 'ai_calculate_tokens_instant'
                });

                const response = await fetch(window.aiSettings.ajaxurl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    setCalculatedTokens(data.data);
                    setCurrentStep('configure');
                } else {
                    setError(data.data?.message || 'Failed to calculate tokens');
                }
            } catch (err) {
                setError('Network error: ' + err.message);
            } finally {
                setIsCalculating(false);
            }
        };

        // Generate content
        const generateContent = async function() {
            setIsGenerating(true);
            setError(null);

            try {
                const formData = new URLSearchParams({
                    post_id: postId,
                    post_title: postTitle,
                    post_content: postContent,
                    post_type: postType,
                    selected_options: JSON.stringify(selectedOptions),
                    length_settings: JSON.stringify(lengthSettings),
                    instructions: JSON.stringify(instructions),
                    model: selectedModel,
                    provider: selectedProvider,
                    nonce: window.aiSettings.nonce,
                    action: 'ai_generate_instant'
                });

                const response = await fetch(window.aiSettings.ajaxurl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    setGeneratedContent(data.data.content);
                    setCurrentStep('result');
                } else {
                    setError(data.data?.message || 'Failed to generate content');
                }
            } catch (err) {
                setError('Network error: ' + err.message);
            } finally {
                setIsGenerating(false);
            }
        };

        // Apply content to editor
        const applyContent = function(key, value) {
            // For Gutenberg editor
            if (window.wp && window.wp.data && window.wp.data.select('core/editor')) {
                const editor = window.wp.data.dispatch('core/editor');
                
                if (key === 'title') {
                    editor.editPost({ title: value });
                } else if (key === 'content') {
                    editor.resetBlocks(window.wp.blocks.parse(value));
                } else if (key === 'excerpt') {
                    editor.editPost({ excerpt: value });
                }
            } 
            // For Classic editor
            else {
                if (key === 'title' && document.getElementById('title')) {
                    document.getElementById('title').value = value;
                } else if (key === 'content' && window.tinyMCE && window.tinyMCE.activeEditor) {
                    window.tinyMCE.activeEditor.setContent(value);
                } else if (key === 'excerpt' && document.getElementById('excerpt')) {
                    document.getElementById('excerpt').value = value;
                }
            }

            // Show success message
            const message = document.createElement('div');
            message.className = 'ai-success-message';
            message.textContent = key + ' applied successfully!';
            document.body.appendChild(message);
            setTimeout(function() { 
                if (message.parentNode) {
                    message.parentNode.removeChild(message); 
                }
            }, 3000);
        };

        // Render step content
        const renderStepContent = function() {
            if (currentStep === 'select') {
                return createElement('div', { className: 'ai-step-select' },
                    createElement('h3', null, 'Select Content to Generate'),
                    createElement('div', { className: 'ai-options-grid' },
                        availableOptions.map(function(option) {
                            const isSelected = selectedOptions.includes(option.key);
                            return createElement('div', {
                                key: option.key,
                                className: 'ai-option-card' + (isSelected ? ' selected' : ''),
                                onClick: function() { toggleOption(option.key); }
                            },
                                createElement('div', { className: 'ai-option-icon' }, option.icon),
                                createElement('div', { className: 'ai-option-content' },
                                    createElement('h4', null, option.label),
                                    createElement('p', null, option.description)
                                ),
                                createElement('div', { className: 'ai-option-checkbox' },
                                    createElement('input', {
                                        type: 'checkbox',
                                        checked: isSelected,
                                        onChange: function() {}
                                    })
                                )
                            );
                        })
                    )
                );
            }

            if (currentStep === 'configure') {
                return createElement('div', { className: 'ai-step-configure' },
                    createElement('h3', null, 'Configure Generation Settings'),
                    createElement('div', { className: 'ai-config-sections' },
                        selectedOptions.map(function(optionKey) {
                            const option = availableOptions.find(function(o) { return o.key === optionKey; });
                            return createElement('div', { key: optionKey, className: 'ai-config-section' },
                                createElement('h4', null, option.icon + ' ' + option.label),
                                createElement('div', { className: 'ai-config-field' },
                                    createElement('label', null, 'Length (words):'),
                                    createElement('input', {
                                        type: 'range',
                                        min: '10',
                                        max: '1000',
                                        value: lengthSettings[optionKey] || 100,
                                        onChange: function(e) {
                                            const newSettings = Object.assign({}, lengthSettings);
                                            newSettings[optionKey] = parseInt(e.target.value);
                                            setLengthSettings(newSettings);
                                        }
                                    }),
                                    createElement('span', null, (lengthSettings[optionKey] || 100) + ' words')
                                ),
                                createElement('div', { className: 'ai-config-field' },
                                    createElement('label', null, 'Special Instructions:'),
                                    createElement('textarea', {
                                        placeholder: 'Add any specific requirements...',
                                        value: instructions[optionKey] || '',
                                        onChange: function(e) {
                                            const newInstructions = Object.assign({}, instructions);
                                            newInstructions[optionKey] = e.target.value;
                                            setInstructions(newInstructions);
                                        },
                                        maxLength: '300'
                                    })
                                )
                            );
                        })
                    ),
                    
                    calculatedTokens ? createElement('div', { className: 'ai-token-info' },
                        createElement('div', { className: 'token-summary' },
                            createElement('span', null, 'Estimated Tokens: ' + calculatedTokens.total_tokens),
                            createElement('span', null, 'Estimated Cost: $' + calculatedTokens.total_cost)
                        )
                    ) : null
                );
            }

            if (currentStep === 'result') {
                return createElement('div', { className: 'ai-step-result' },
                    createElement('h3', null, 'Generated Content'),
                    createElement('div', { className: 'ai-results-container' },
                        Object.keys(generatedContent).map(function(key) {
                            const value = generatedContent[key];
                            const option = availableOptions.find(function(o) { return o.key === key; });
                            return createElement('div', { key: key, className: 'ai-result-item' },
                                createElement('div', { className: 'ai-result-header' },
                                    createElement('h4', null, option?.icon + ' ' + option?.label),
                                    createElement('button', {
                                        className: 'ai-apply-btn',
                                        onClick: function() { applyContent(key, value); }
                                    }, 'Apply to Editor')
                                ),
                                createElement('div', { className: 'ai-result-content' },
                                    createElement('pre', null, value)
                                )
                            );
                        })
                    )
                );
            }

            return null;
        };

        const renderFooterButtons = function() {
            if (currentStep === 'select') {
                return createElement('button', {
                    className: 'ai-btn ai-btn-primary',
                    onClick: calculateTokens,
                    disabled: selectedOptions.length === 0 || isCalculating
                }, isCalculating ? 'Calculating...' : 'Next: Configure Settings');
            }

            if (currentStep === 'configure') {
                return createElement('div', { style: { display: 'flex', gap: '12px' } },
                    createElement('button', {
                        className: 'ai-btn ai-btn-secondary',
                        onClick: function() { setCurrentStep('select'); }
                    }, 'Back'),
                    createElement('button', {
                        className: 'ai-btn ai-btn-primary',
                        onClick: generateContent,
                        disabled: isGenerating
                    }, 
                        isGenerating ? 
                            createElement('span', null, 
                                createElement('span', { className: 'ai-spinner' }),
                                'Generating...'
                            ) : 
                            'üöÄ Generate Content'
                    )
                );
            }

            if (currentStep === 'result') {
                return createElement('div', { style: { display: 'flex', gap: '12px' } },
                    createElement('button', {
                        className: 'ai-btn ai-btn-secondary',
                        onClick: function() {
                            setCurrentStep('select');
                            setGeneratedContent({});
                        }
                    }, 'Generate More'),
                    createElement('button', {
                        className: 'ai-btn ai-btn-primary',
                        onClick: onClose
                    }, 'Done')
                );
            }

            return null;
        };

        // Main render
        return createElement('div', { 
            className: 'ai-generator-popup-overlay',
            onClick: onClose 
        },
            createElement('div', { 
                className: 'ai-generator-popup',
                onClick: function(e) { e.stopPropagation(); }
            },
                createElement('div', { className: 'ai-popup-header' },
                    createElement('h2', null, 'ü§ñ AI Content Generator'),
                    createElement('button', { 
                        className: 'ai-close-btn',
                        onClick: onClose 
                    }, '√ó')
                ),

                createElement('div', { className: 'ai-popup-body' },
                    error ? createElement('div', { className: 'ai-error-message' },
                        '‚ö†Ô∏è ' + error
                    ) : null,
                    renderStepContent()
                ),

                createElement('div', { className: 'ai-popup-footer' },
                    renderFooterButtons()
                )
            )
        );
    }

    // Export to global scope for WordPress
    window.AIContentGeneratorPopup = ContentGeneratorPopup;

})();